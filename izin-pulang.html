<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Izin Pulang</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>Izin Pulang</h1>
    <div id="siswa-list"></div>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCqcq-UD2tG0d3xGQjcQ1ADYFHsHuBI_O0",
            authDomain: "new-attendance-37fb7.firebaseapp.com",
            databaseURL: "https://new-attendance-37fb7-default-rtdb.firebaseio.com",
            projectId: "new-attendance-37fb7",
            storageBucket: "new-attendance-37fb7.appspot.com",
            messagingSenderId: "112170477897",
            appId: "1:112170477897:android:b7a39805bf546a1d9ad298"
        };

        firebase.initializeApp(firebaseConfig);

        window.addEventListener("load", function() {
            const db = firebase.database();
            const siswaRef = db.ref("siswa");
            const izinRef = db.ref("izin-pulang");
            const siswaList = document.getElementById("siswa-list");

            siswaRef.on("value", function(snapshot) {
                siswaList.innerHTML = "";

                snapshot.forEach(function(childSnapshot) {
                    const siswa = childSnapshot.val();
                    const siswaKey = childSnapshot.key;
                    const listItem = document.createElement("div");
                    const siswaName = document.createElement("span");
                    siswaName.textContent = `Nama: ${siswa.nama}, Kota: ${siswa.asalKota}`;
                    const izinButton = document.createElement("button");

                    // Periksa apakah siswa sudah mengajukan izin sebelumnya
                    izinRef.orderByChild("siswaKey").equalTo(siswaKey).once("value", function(izinSnapshot) {
                        if (izinSnapshot.exists()) {
                            izinSnapshot.forEach(function(izinChild) {
                                const izinData = izinChild.val();
                                const tanggalIzin = new Date(izinData.tanggalIzin);
                                const hariIni = new Date();
                                const selisihHari = Math.floor((hariIni - tanggalIzin) / (1000 * 60 * 60 * 24));

                                if (selisihHari >= 14) {
                                    izinButton.textContent = "Ajukan Izin";
                                    izinButton.disabled = false;
                                } else {
                                    const tanggalBolehPulang = new Date(tanggalIzin);
                                    tanggalBolehPulang.setDate(tanggalBolehPulang.getDate() + 14);
                                    izinButton.textContent = `Boleh pulang setelah ${tanggalBolehPulang.toDateString()}`;
                                    izinButton.disabled = true;
                                }
                            });
                        } else {
                            izinButton.textContent = "Ajukan Izin";
                            izinButton.disabled = false;
                        }

                        izinButton.addEventListener("click", function() {
                            izinRef.push({
                                siswaKey: siswaKey,
                                nama: siswa.nama,
                                asalKota: siswa.asalKota,
                                tanggalIzin: new Date().toISOString()
                            }).then(() => {
                                alert(`Izin pulang untuk ${siswa.nama} berhasil diajukan!`);
                                window.location.reload();
                            }).catch((error) => {
                                console.error("Error submitting leave request: ", error);
                            });
                        });
                    });

                    listItem.appendChild(siswaName);
                    listItem.appendChild(izinButton);
                    siswaList.appendChild(listItem);
                });
            });
        });
    </script>
</body>
</html>
